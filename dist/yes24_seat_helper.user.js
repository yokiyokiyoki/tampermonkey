// ==UserScript==
// @name         yes24座位分析助手
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  分析yes24网站上的座位可选状态，支持限制座位选择数量，使用DOM观察器替代轮询
// @author       You
// @match        *://ticket.yes24.com/*
// @match        *://*.ticket.yes24.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        window.focus
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";function t(t){try{var e={allSeats:'#divSeatArray div[class^="s"]',availableSeats:"#divSeatArray div.s9, #divSeatArray div.s6, #divSeatArray div.s8",vipSeats:"#divSeatArray div.s9",rSeats:"#divSeatArray div.s6",sSeats:"#divSeatArray div.s8",selectedList:"#liSelSeat p"},n=Array.from(t.querySelectorAll(e.allSeats)||[]),a=Array.from(t.querySelectorAll(e.availableSeats)||[]),o=Array.from(t.querySelectorAll(e.vipSeats)||[]),i=Array.from(t.querySelectorAll(e.rSeats)||[]),s=Array.from(t.querySelectorAll(e.sSeats)||[]),r=Array.from(t.querySelectorAll(e.selectedList)||[]),l=n.map((function(t){var e=t.getAttribute("title")||"",n=t.id||"",a=t.getAttribute("grade")||"",o="";return t.classList.contains("s9")?(o="VIP席",{id:n,element:t,title:e,grade:a||o,type:o,isAvailable:!0}):t.classList.contains("s6")?(o="R席",{id:n,element:t,title:e,grade:a||o,type:o,isAvailable:!0}):t.classList.contains("s8")?(o="S席",{id:n,element:t,title:e,grade:a||o,type:o,isAvailable:!0}):{id:n,element:t,title:e,grade:a||"普通席",type:o="已售/不可用",isAvailable:!1}})),c=o.map((function(t){return{id:t.id||"",element:t,title:t.getAttribute("title")||"",grade:t.getAttribute("grade")||"VIP席",type:"VIP席",isAvailable:!0}})),d=i.map((function(t){return{id:t.id||"",element:t,title:t.getAttribute("title")||"",grade:t.getAttribute("grade")||"R席",type:"R席",isAvailable:!0}})),u=s.map((function(t){return{id:t.id||"",element:t,title:t.getAttribute("title")||"",grade:t.getAttribute("grade")||"S席",type:"S席",isAvailable:!0}})),v=a.map((function(t){var e="普通席";return t.classList.contains("s9")?e="VIP席":t.classList.contains("s6")?e="R席":t.classList.contains("s8")&&(e="S席"),{id:t.id||"",element:t,title:t.getAttribute("title")||"",grade:t.getAttribute("grade")||e,type:e,isAvailable:!0}})),f=r.map((function(t){var e=t.textContent||"";return{id:e,text:e}})),m={total:n.length,available:a.length,vip:o.length,r:i.length,s:s.length,selected:r.length,seatsWithInfo:l,selectedSeatsInfo:f,vipInfo:c,rInfo:d,sInfo:u,availableInfo:v,allSeatsInfo:l};return console.log("分析座位信息完成，共发现：",{总座位:m.total,可选座位:m.available,VIP席:m.vip,R席:m.r,S席:m.s,已选座位:m.selected}),m}catch(t){return console.error("分析座位信息时出错:",t),{total:0,available:0,vip:0,r:0,s:0,selected:0,seatsWithInfo:[],selectedSeatsInfo:[],vipInfo:[],rInfo:[],sInfo:[],availableInfo:[],allSeatsInfo:[]}}}function e(t){if(document.getElementById("yes24SeatAssistant"))return console.log("面板已存在，更新数据"),void n(t);var e;console.log("创建座位助手面板"),(e=document.createElement("style")).textContent='#yes24SeatAssistant{position:fixed;top:20px;right:20px;width:280px;background-color:rgba(33,37,41,.95);color:#fff;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:10000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);overflow:hidden;transition:all .3s ease}.seat-assistant-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:linear-gradient(135deg,#4568dc,#3a6073);border-bottom:1px solid rgba(255,255,255,.1)}.seat-assistant-title{font-size:16px;font-weight:700;display:flex;align-items:center}.seat-assistant-icon{margin-right:8px;font-size:18px}.seat-assistant-close{cursor:pointer;font-size:18px;opacity:.8;transition:opacity .2s;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%}.seat-assistant-close:hover{opacity:1;background-color:rgba(255,255,255,.1)}.seat-assistant-body{padding:15px}.seat-assistant-section{margin-bottom:15px;background:rgba(0,0,0,.2);border-radius:6px;padding:12px}.seat-assistant-section-title{margin-bottom:10px;font-size:14px;font-weight:500;color:#adb5bd;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:5px}.seat-count-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.seat-count-item{text-align:center;background:rgba(0,0,0,.2);border-radius:4px;padding:8px 4px}.seat-count-label{font-size:12px;color:#adb5bd;margin-bottom:4px}.seat-count-value{font-size:18px;font-weight:700}.vip-seat{color:#20c997}.r-seat{color:#339af0}.s-seat{color:#fcc419}.available-seat{color:#51cf66}.selected-seat{color:#ff6b6b}.selected-seats-list{max-height:120px;overflow-y:auto;background:rgba(0,0,0,.15);border-radius:4px;margin-top:8px}.selected-seat-item{padding:6px 10px;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}.selected-seat-item.empty{color:#868e96;text-align:center;padding:15px}',document.head.appendChild(e);var a=document.createElement("div");a.id="yes24SeatAssistant",a.innerHTML='\n        <div class="seat-assistant-header">\n            <div class="seat-assistant-title">\n                <span class="seat-assistant-icon">🎟️</span>\n                Yes24座位助手\n            </div>\n            <div class="seat-assistant-controls">\n                <div class="seat-assistant-close" title="关闭">×</div>\n            </div>\n        </div>\n        <div class="seat-assistant-body">\n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">座位概况</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">全部座位</div>\n                        <div class="seat-count-value" id="totalSeatsCount">'.concat(t.total,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">可选座位</div>\n                        <div class="seat-count-value available-seat" id="availableSeatsCount">').concat(t.available,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">已选座位</div>\n                        <div class="seat-count-value selected-seat" id="selectedSeatsCount">').concat(t.selected,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">可选座位类型</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">VIP席</div>\n                        <div class="seat-count-value vip-seat" id="vipSeatsCount">').concat(t.vip,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">R席</div>\n                        <div class="seat-count-value r-seat" id="rSeatsCount">').concat(t.r,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">S席</div>\n                        <div class="seat-count-value s-seat" id="sSeatsCount">').concat(t.s,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">已选座位</div>\n                <div class="selected-seats-list" id="selectedSeatsList">\n                    ').concat(t.selectedSeatsInfo.length>0?t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):'<div class="selected-seat-item empty">暂无已选座位</div>',"\n                </div>\n            </div>\n        </div>\n    "),document.body.appendChild(a),document.querySelector("#yes24SeatAssistant .seat-assistant-close").addEventListener("click",(function(){a.remove()})),console.log("面板创建完成")}function n(t){if(document.getElementById("yes24SeatAssistant")){document.getElementById("totalSeatsCount").textContent=t.total,document.getElementById("availableSeatsCount").textContent=t.available,document.getElementById("selectedSeatsCount").textContent=t.selected,document.getElementById("vipSeatsCount").textContent=t.vip,document.getElementById("rSeatsCount").textContent=t.r,document.getElementById("sSeatsCount").textContent=t.s;var e=document.getElementById("selectedSeatsList");t.selectedSeatsInfo.length>0?e.innerHTML=t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):e.innerHTML='<div class="selected-seat-item empty">暂无已选座位</div>'}}var a=null,o=!1;function i(n){if(!o)try{console.log("初始化座位助手..."),a=n,e(t(n.contentDocument)),function(t){var e=t.contentDocument,n=e.querySelector(".seatarea");if(!n)return void console.warn("未找到座位区域，无法设置监控");new MutationObserver((function(t){t.some((function(t){return"attributes"===t.type?["class","style"].includes(t.attributeName):"childList"===t.type}))&&(console.log("检测到座位变化，更新数据"),s())})).observe(n,{childList:!0,attributes:!0,subtree:!0,attributeFilter:["class","style"]});var a=e.querySelector("#liSelSeat");a&&new MutationObserver((function(){console.log("检测到已选座位列表变化"),s()})).observe(a,{childList:!0,subtree:!0});console.log("座位监控已设置")}(n),o=!0}catch(t){console.error("初始化座位助手时出错:",t)}}function s(){a&&o&&n(t(a.contentDocument))}function r(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return l(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,o=function(){};return{s:o,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,r=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){r=!0,i=t},f:function(){try{s||null==n.return||n.return()}finally{if(r)throw i}}}}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function c(){console.log("初始化iframe检测模块"),function(){var t=document.querySelector('iframe[name="ifrmSeatFrame"]');if(t)return void d(t);!function(){console.log("未找到座位iframe，开始监控DOM变化");var t=new MutationObserver((function(e){var n,a=r(e);try{for(a.s();!(n=a.n()).done;){var o=n.value;if("childList"===o.type&&o.addedNodes.length){var i=document.querySelector('iframe[name="ifrmSeatFrame"]');if(i){console.log("通过DOM变化监控发现座位iframe!"),t.disconnect(),d(i);break}}}}catch(t){a.e(t)}finally{a.f()}}));t.observe(document.body,{childList:!0,subtree:!0}),setTimeout((function(){t.disconnect(),console.log("停止DOM监控 (30秒超时)")}),3e4)}()}()}function d(t){console.log("发现座位iframe，准备初始化座位助手"),t.contentDocument&&"complete"===t.contentDocument.readyState&&t.contentDocument.querySelector(".seatarea")?(console.log("iframe内容已加载，直接初始化座位助手"),i(t)):t.addEventListener("load",(function(){console.log("座位iframe内容已加载完成"),i(t)}))}function u(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return v(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?v(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,o=function(){};return{s:o,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,r=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){r=!0,i=t},f:function(){try{s||null==n.return||n.return()}finally{if(r)throw i}}}}function v(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function f(){console.log("初始化Alert自动处理模块");window.alert;window.alert=function(t){console.log("检测到Alert弹窗，内容:",t),console.log("自动关闭Alert")};window.confirm;window.confirm=function(t){return console.log("检测到Confirm弹窗，内容:",t),console.log("自动确认Confirm"),!0},new MutationObserver((function(t){var e,n=u(t);try{for(n.s();!(e=n.n()).done;){var a=e.value;"childList"===a.type&&a.addedNodes.length&&document.querySelectorAll("iframe").forEach((function(t){try{t.contentWindow&&!t.alertOverridden&&(m(t),t.alertOverridden=!0)}catch(t){console.log("无法访问iframe内容:",t)}}))}}catch(t){n.e(t)}finally{n.f()}})).observe(document.documentElement,{childList:!0,subtree:!0}),document.querySelectorAll("iframe").forEach((function(t){try{m(t),t.alertOverridden=!0}catch(t){console.log("无法访问已存在的iframe内容:",t)}})),console.log("Alert自动处理模块初始化完成")}function m(t){try{t.contentWindow&&t.addEventListener("load",(function(){try{var e=t.contentWindow;e.alert,e.confirm;e.alert=function(t){console.log("检测到iframe中的Alert弹窗，内容:",t),console.log("自动关闭iframe中的Alert")},e.confirm=function(t){return console.log("检测到iframe中的Confirm弹窗，内容:",t),console.log("自动确认iframe中的Confirm"),!0},console.log("成功重写iframe alert")}catch(t){console.error("重写iframe alert失败:",t)}}))}catch(t){console.error("访问iframe时出错:",t)}}!function(){function t(){f(),c()}console.log("Yes24购票助手已加载"),"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",t)}()})();