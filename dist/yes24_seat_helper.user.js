// ==UserScript==
// @name         yes24åº§ä½åˆ†æåŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  åˆ†æyes24ç½‘ç«™ä¸Šçš„åº§ä½å¯é€‰çŠ¶æ€ï¼Œæ”¯æŒé™åˆ¶åº§ä½é€‰æ‹©æ•°é‡ï¼Œä½¿ç”¨DOMè§‚å¯Ÿå™¨æ›¿ä»£è½®è¯¢
// @author       You
// @match        *://ticket.yes24.com/*
// @match        *://*.ticket.yes24.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        window.focus
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";
/**
 * åˆ†æåº§ä½ä¿¡æ¯
 * @param {Document} doc - iframeçš„contentDocument
 * @returns {Object} åŒ…å«åº§ä½ä¿¡æ¯çš„å¯¹è±¡
 */
function t(t){try{var e={allSeats:'#divSeatArray div[class^="s"]',availableSeats:"#divSeatArray div.s13",vipSeats:"#divSeatArray div.s9",rSeats:"#divSeatArray div.s6",sSeats:"#divSeatArray div.s8",selectedList:"#liSelSeat p"},n=Array.from(t.querySelectorAll(e.allSeats)||[]),a=Array.from(t.querySelectorAll(e.availableSeats)||[]),s=Array.from(t.querySelectorAll(e.vipSeats)||[]),i=Array.from(t.querySelectorAll(e.rSeats)||[]),o=Array.from(t.querySelectorAll(e.sSeats)||[]),l=Array.from(t.querySelectorAll(e.selectedList)||[]),r=n.map((function(t){var e=t.getAttribute("title")||"",n=t.id||"",a="";return a=t.classList.contains("s9")?"VIPå¸­":t.classList.contains("s6")?"Rå¸­":t.classList.contains("s8")?"Så¸­":"æ™®é€šå¸­",{id:n,element:t,title:e,grade:a,isAvailable:t.classList.contains("s13")}})),c=l.map((function(t){var e=t.textContent||"";return{id:e,text:e}}));return{total:n.length,available:a.length,vip:s.length,r:i.length,s:o.length,selected:l.length,seatsWithInfo:r,selectedSeatsInfo:c}}catch(t){return console.error("åˆ†æåº§ä½ä¿¡æ¯æ—¶å‡ºé”™:",t),{total:0,available:0,vip:0,r:0,s:0,selected:0,seatsWithInfo:[],selectedSeatsInfo:[]}}}
/**
 * åˆ›å»ºæ§åˆ¶é¢æ¿
 * @param {Object} seatInfo - åº§ä½ä¿¡æ¯å¯¹è±¡
 */
function e(t){if(document.getElementById("yes24SeatAssistant"))return console.log("é¢æ¿å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°æ®"),void n(t);var e;console.log("åˆ›å»ºåº§ä½åŠ©æ‰‹é¢æ¿"),(e=document.createElement("style")).textContent='\n        #yes24SeatAssistant {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            width: 280px;\n            background-color: rgba(33, 37, 41, 0.95);\n            color: #ffffff;\n            border-radius: 8px;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);\n            z-index: 10000;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;\n            backdrop-filter: blur(5px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            overflow: hidden;\n            transition: all 0.3s ease;\n        }\n        \n        .seat-assistant-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 12px 15px;\n            background: linear-gradient(135deg, #4568dc, #3a6073);\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        \n        .seat-assistant-title {\n            font-size: 16px;\n            font-weight: bold;\n            display: flex;\n            align-items: center;\n        }\n        \n        .seat-assistant-icon {\n            margin-right: 8px;\n            font-size: 18px;\n        }\n        \n        .seat-assistant-close {\n            cursor: pointer;\n            font-size: 18px;\n            opacity: 0.8;\n            transition: opacity 0.2s;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 50%;\n        }\n        \n        .seat-assistant-close:hover {\n            opacity: 1;\n            background-color: rgba(255, 255, 255, 0.1);\n        }\n        \n        .seat-assistant-body {\n            padding: 15px;\n        }\n        \n        .seat-assistant-section {\n            margin-bottom: 15px;\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n        }\n        \n        .seat-assistant-section-title {\n            margin-bottom: 10px;\n            font-size: 14px;\n            font-weight: 500;\n            color: #adb5bd;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            padding-bottom: 5px;\n        }\n        \n        .seat-count-grid {\n            display: grid;\n            grid-template-columns: repeat(3, 1fr);\n            gap: 8px;\n        }\n        \n        .seat-count-item {\n            text-align: center;\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 4px;\n            padding: 8px 4px;\n        }\n        \n        .seat-count-label {\n            font-size: 12px;\n            color: #adb5bd;\n            margin-bottom: 4px;\n        }\n        \n        .seat-count-value {\n            font-size: 18px;\n            font-weight: bold;\n        }\n        \n        .vip-seat { color: #20c997; }\n        .r-seat { color: #339af0; }\n        .s-seat { color: #fcc419; }\n        .available-seat { color: #51cf66; }\n        .selected-seat { color: #ff6b6b; }\n        \n        .selected-seats-list {\n            max-height: 120px;\n            overflow-y: auto;\n            background: rgba(0, 0, 0, 0.15);\n            border-radius: 4px;\n            margin-top: 8px;\n        }\n        \n        .selected-seat-item {\n            padding: 6px 10px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            font-size: 13px;\n        }\n        \n        .selected-seat-item.empty {\n            color: #868e96;\n            text-align: center;\n            padding: 15px;\n        }\n    ',document.head.appendChild(e);var a=document.createElement("div");a.id="yes24SeatAssistant",a.innerHTML='\n        <div class="seat-assistant-header">\n            <div class="seat-assistant-title">\n                <span class="seat-assistant-icon">ğŸŸï¸</span>\n                Yes24åº§ä½åŠ©æ‰‹\n            </div>\n            <div class="seat-assistant-controls">\n                <div class="seat-assistant-close" title="å…³é—­">Ã—</div>\n            </div>\n        </div>\n        <div class="seat-assistant-body">\n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">åº§ä½æ¦‚å†µ</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å…¨éƒ¨åº§ä½</div>\n                        <div class="seat-count-value" id="totalSeatsCount">'.concat(t.total,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å¯é€‰åº§ä½</div>\n                        <div class="seat-count-value available-seat" id="availableSeatsCount">').concat(t.available,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å·²é€‰åº§ä½</div>\n                        <div class="seat-count-value selected-seat" id="selectedSeatsCount">').concat(t.selected,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">åº§ä½ç±»å‹</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">VIPå¸­</div>\n                        <div class="seat-count-value vip-seat" id="vipSeatsCount">').concat(t.vip,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">Rå¸­</div>\n                        <div class="seat-count-value r-seat" id="rSeatsCount">').concat(t.r,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">Så¸­</div>\n                        <div class="seat-count-value s-seat" id="sSeatsCount">').concat(t.s,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">å·²é€‰åº§ä½</div>\n                <div class="selected-seats-list" id="selectedSeatsList">\n                    ').concat(t.selectedSeatsInfo.length>0?t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):'<div class="selected-seat-item empty">æš‚æ— å·²é€‰åº§ä½</div>',"\n                </div>\n            </div>\n        </div>\n    "),document.body.appendChild(a),document.querySelector("#yes24SeatAssistant .seat-assistant-close").addEventListener("click",(function(){a.remove()})),console.log("é¢æ¿åˆ›å»ºå®Œæˆ")}
/**
 * æ›´æ–°é¢æ¿æ•°æ®
 * @param {Object} seatInfo - åº§ä½ä¿¡æ¯å¯¹è±¡
 */function n(t){if(document.getElementById("yes24SeatAssistant")){document.getElementById("totalSeatsCount").textContent=t.total,document.getElementById("availableSeatsCount").textContent=t.available,document.getElementById("selectedSeatsCount").textContent=t.selected,document.getElementById("vipSeatsCount").textContent=t.vip,document.getElementById("rSeatsCount").textContent=t.r,document.getElementById("sSeatsCount").textContent=t.s;var e=document.getElementById("selectedSeatsList");t.selectedSeatsInfo.length>0?e.innerHTML=t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):e.innerHTML='<div class="selected-seat-item empty">æš‚æ— å·²é€‰åº§ä½</div>'}}var a=null,s=!1;
/**
 * åˆå§‹åŒ–åº§ä½åŠ©æ‰‹
 * @param {HTMLIFrameElement} iframe - åŒ…å«åº§ä½çš„iframeå…ƒç´ 
 */
function i(n){if(!s)try{console.log("åˆå§‹åŒ–åº§ä½åŠ©æ‰‹..."),a=n,e(t(n.contentDocument)),
/**
 * è®¾ç½®åº§ä½ç›‘æ§
 * @param {HTMLIFrameElement} iframe - åŒ…å«åº§ä½çš„iframeå…ƒç´ 
 */
function(t){var e=t.contentDocument,n=e.querySelector(".seatarea");if(!n)return void console.warn("æœªæ‰¾åˆ°åº§ä½åŒºåŸŸï¼Œæ— æ³•è®¾ç½®ç›‘æ§");new MutationObserver((function(t){t.some((function(t){return"attributes"===t.type?["class","style"].includes(t.attributeName):"childList"===t.type}))&&(console.log("æ£€æµ‹åˆ°åº§ä½å˜åŒ–ï¼Œæ›´æ–°æ•°æ®"),o())})).observe(n,{childList:!0,attributes:!0,subtree:!0,attributeFilter:["class","style"]});var a=e.querySelector("#liSelSeat");a&&new MutationObserver((function(){console.log("æ£€æµ‹åˆ°å·²é€‰åº§ä½åˆ—è¡¨å˜åŒ–"),o()})).observe(a,{childList:!0,subtree:!0});console.log("åº§ä½ç›‘æ§å·²è®¾ç½®")}(n),s=!0}catch(t){console.error("åˆå§‹åŒ–åº§ä½åŠ©æ‰‹æ—¶å‡ºé”™:",t)}}function o(){a&&s&&n(t(a.contentDocument))}function l(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,s=function(){};return{s,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function c(){console.log("åˆå§‹åŒ–iframeæ£€æµ‹æ¨¡å—"),function(){var t=document.querySelector('iframe[name="ifrmSeatFrame"]');if(t)return void d(t);!function(){console.log("æœªæ‰¾åˆ°åº§ä½iframeï¼Œå¼€å§‹ç›‘æ§DOMå˜åŒ–");var t=new MutationObserver((function(e){var n,a=l(e);try{for(a.s();!(n=a.n()).done;){var s=n.value;if("childList"===s.type&&s.addedNodes.length){var i=document.querySelector('iframe[name="ifrmSeatFrame"]');if(i){console.log("é€šè¿‡DOMå˜åŒ–ç›‘æ§å‘ç°åº§ä½iframe!"),t.disconnect(),d(i);break}}}}catch(t){a.e(t)}finally{a.f()}}));t.observe(document.body,{childList:!0,subtree:!0}),setTimeout((function(){t.disconnect(),console.log("åœæ­¢DOMç›‘æ§ (30ç§’è¶…æ—¶)")}),3e4)}()}()}function d(t){console.log("å‘ç°åº§ä½iframeï¼Œå‡†å¤‡åˆå§‹åŒ–åº§ä½åŠ©æ‰‹"),t.contentDocument&&"complete"===t.contentDocument.readyState&&t.contentDocument.querySelector(".seatarea")?(console.log("iframeå†…å®¹å·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–åº§ä½åŠ©æ‰‹"),i(t)):t.addEventListener("load",(function(){console.log("åº§ä½iframeå†…å®¹å·²åŠ è½½å®Œæˆ"),i(t)}))}!function(){function t(){c()}console.log("Yes24è´­ç¥¨åŠ©æ‰‹å·²åŠ è½½"),"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",t)}()})();