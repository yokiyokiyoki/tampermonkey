// ==UserScript==
// @name         yes24åº§ä½åˆ†æåŠ©æ‰‹
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  åˆ†æyes24ç½‘ç«™ä¸Šçš„åº§ä½å¯é€‰çŠ¶æ€ï¼Œæ”¯æŒé™åˆ¶åº§ä½é€‰æ‹©æ•°é‡ï¼Œä½¿ç”¨DOMè§‚å¯Ÿå™¨æ›¿ä»£è½®è¯¢
// @author       You
// @match        *://ticket.yes24.com/*
// @match        *://*.ticket.yes24.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        window.focus
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";function e(e){try{var t={allSeats:'#divSeatArray div[class^="s"]',availableSeats:"#divSeatArray div.s9, #divSeatArray div.s6, #divSeatArray div.s8",vipSeats:"#divSeatArray div.s9",rSeats:"#divSeatArray div.s6",sSeats:"#divSeatArray div.s8",selectedList:"#liSelSeat p"},n=Array.from(e.querySelectorAll(t.allSeats)||[]),a=Array.from(e.querySelectorAll(t.availableSeats)||[]),o=Array.from(e.querySelectorAll(t.vipSeats)||[]),s=Array.from(e.querySelectorAll(t.rSeats)||[]),i=Array.from(e.querySelectorAll(t.sSeats)||[]),r=Array.from(e.querySelectorAll(t.selectedList)||[]),l=n.map((function(e){var t=e.getAttribute("title")||"",n=e.id||"",a=e.getAttribute("grade")||"",o="";return e.classList.contains("s9")?(o="VIPå¸­",{id:n,element:e,title:t,grade:a||o,type:o,isAvailable:!0}):e.classList.contains("s6")?(o="Rå¸­",{id:n,element:e,title:t,grade:a||o,type:o,isAvailable:!0}):e.classList.contains("s8")?(o="Så¸­",{id:n,element:e,title:t,grade:a||o,type:o,isAvailable:!0}):{id:n,element:e,title:t,grade:a||"æ™®é€šå¸­",type:o="å·²å”®/ä¸å¯ç”¨",isAvailable:!1}})),c=r.map((function(e){var t=e.textContent||"";return{id:t,text:t}}));return{total:n.length,available:a.length,vip:o.length,r:s.length,s:i.length,selected:r.length,seatsWithInfo:l,selectedSeatsInfo:c}}catch(e){return console.error("åˆ†æåº§ä½ä¿¡æ¯æ—¶å‡ºé”™:",e),{total:0,available:0,vip:0,r:0,s:0,selected:0,seatsWithInfo:[],selectedSeatsInfo:[]}}}function t(e){if(document.getElementById("yes24SeatAssistant"))return console.log("é¢æ¿å·²å­˜åœ¨ï¼Œæ›´æ–°æ•°æ®"),void n(e);var t;console.log("åˆ›å»ºåº§ä½åŠ©æ‰‹é¢æ¿"),(t=document.createElement("style")).textContent='#yes24SeatAssistant{position:fixed;top:20px;right:20px;width:280px;background-color:rgba(33,37,41,.95);color:#fff;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.3);z-index:10000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);overflow:hidden;transition:all .3s ease}.seat-assistant-header{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:linear-gradient(135deg,#4568dc,#3a6073);border-bottom:1px solid rgba(255,255,255,.1)}.seat-assistant-title{font-size:16px;font-weight:700;display:flex;align-items:center}.seat-assistant-icon{margin-right:8px;font-size:18px}.seat-assistant-close{cursor:pointer;font-size:18px;opacity:.8;transition:opacity .2s;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%}.seat-assistant-close:hover{opacity:1;background-color:rgba(255,255,255,.1)}.seat-assistant-body{padding:15px}.seat-assistant-section{margin-bottom:15px;background:rgba(0,0,0,.2);border-radius:6px;padding:12px}.seat-assistant-section-title{margin-bottom:10px;font-size:14px;font-weight:500;color:#adb5bd;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:5px}.seat-count-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.seat-count-item{text-align:center;background:rgba(0,0,0,.2);border-radius:4px;padding:8px 4px}.seat-count-label{font-size:12px;color:#adb5bd;margin-bottom:4px}.seat-count-value{font-size:18px;font-weight:700}.vip-seat{color:#20c997}.r-seat{color:#339af0}.s-seat{color:#fcc419}.available-seat{color:#51cf66}.selected-seat{color:#ff6b6b}.selected-seats-list{max-height:120px;overflow-y:auto;background:rgba(0,0,0,.15);border-radius:4px;margin-top:8px}.selected-seat-item{padding:6px 10px;border-bottom:1px solid rgba(255,255,255,.05);font-size:13px}.selected-seat-item.empty{color:#868e96;text-align:center;padding:15px}',document.head.appendChild(t);var a=document.createElement("div");a.id="yes24SeatAssistant",a.innerHTML='\n        <div class="seat-assistant-header">\n            <div class="seat-assistant-title">\n                <span class="seat-assistant-icon">ğŸŸï¸</span>\n                Yes24åº§ä½åŠ©æ‰‹\n            </div>\n            <div class="seat-assistant-controls">\n                <div class="seat-assistant-close" title="å…³é—­">Ã—</div>\n            </div>\n        </div>\n        <div class="seat-assistant-body">\n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">åº§ä½æ¦‚å†µ</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å…¨éƒ¨åº§ä½</div>\n                        <div class="seat-count-value" id="totalSeatsCount">'.concat(e.total,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å¯é€‰åº§ä½</div>\n                        <div class="seat-count-value available-seat" id="availableSeatsCount">').concat(e.available,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">å·²é€‰åº§ä½</div>\n                        <div class="seat-count-value selected-seat" id="selectedSeatsCount">').concat(e.selected,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">å¯é€‰åº§ä½ç±»å‹</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">VIPå¸­</div>\n                        <div class="seat-count-value vip-seat" id="vipSeatsCount">').concat(e.vip,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">Rå¸­</div>\n                        <div class="seat-count-value r-seat" id="rSeatsCount">').concat(e.r,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">Så¸­</div>\n                        <div class="seat-count-value s-seat" id="sSeatsCount">').concat(e.s,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">å·²é€‰åº§ä½</div>\n                <div class="selected-seats-list" id="selectedSeatsList">\n                    ').concat(e.selectedSeatsInfo.length>0?e.selectedSeatsInfo.map((function(e){return'<div class="selected-seat-item">'.concat(e.text,"</div>")})).join(""):'<div class="selected-seat-item empty">æš‚æ— å·²é€‰åº§ä½</div>',"\n                </div>\n            </div>\n        </div>\n    "),document.body.appendChild(a),document.querySelector("#yes24SeatAssistant .seat-assistant-close").addEventListener("click",(function(){a.remove()})),console.log("é¢æ¿åˆ›å»ºå®Œæˆ")}function n(e){if(document.getElementById("yes24SeatAssistant")){document.getElementById("totalSeatsCount").textContent=e.total,document.getElementById("availableSeatsCount").textContent=e.available,document.getElementById("selectedSeatsCount").textContent=e.selected,document.getElementById("vipSeatsCount").textContent=e.vip,document.getElementById("rSeatsCount").textContent=e.r,document.getElementById("sSeatsCount").textContent=e.s;var t=document.getElementById("selectedSeatsList");e.selectedSeatsInfo.length>0?t.innerHTML=e.selectedSeatsInfo.map((function(e){return'<div class="selected-seat-item">'.concat(e.text,"</div>")})).join(""):t.innerHTML='<div class="selected-seat-item empty">æš‚æ— å·²é€‰åº§ä½</div>'}}var a=null,o=!1;function s(n){if(!o)try{console.log("åˆå§‹åŒ–åº§ä½åŠ©æ‰‹..."),a=n,t(e(n.contentDocument)),function(e){var t=e.contentDocument,n=t.querySelector(".seatarea");if(!n)return void console.warn("æœªæ‰¾åˆ°åº§ä½åŒºåŸŸï¼Œæ— æ³•è®¾ç½®ç›‘æ§");new MutationObserver((function(e){e.some((function(e){return"attributes"===e.type?["class","style"].includes(e.attributeName):"childList"===e.type}))&&(console.log("æ£€æµ‹åˆ°åº§ä½å˜åŒ–ï¼Œæ›´æ–°æ•°æ®"),i())})).observe(n,{childList:!0,attributes:!0,subtree:!0,attributeFilter:["class","style"]});var a=t.querySelector("#liSelSeat");a&&new MutationObserver((function(){console.log("æ£€æµ‹åˆ°å·²é€‰åº§ä½åˆ—è¡¨å˜åŒ–"),i()})).observe(a,{childList:!0,subtree:!0});console.log("åº§ä½ç›‘æ§å·²è®¾ç½®")}(n),o=!0}catch(e){console.error("åˆå§‹åŒ–åº§ä½åŠ©æ‰‹æ—¶å‡ºé”™:",e)}}function i(){a&&o&&n(e(a.contentDocument))}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,r=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){r=!0,s=e},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw s}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function c(){console.log("åˆå§‹åŒ–iframeæ£€æµ‹æ¨¡å—"),function(){var e=document.querySelector('iframe[name="ifrmSeatFrame"]');if(e)return void d(e);!function(){console.log("æœªæ‰¾åˆ°åº§ä½iframeï¼Œå¼€å§‹ç›‘æ§DOMå˜åŒ–");var e=new MutationObserver((function(t){var n,a=r(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;if("childList"===o.type&&o.addedNodes.length){var s=document.querySelector('iframe[name="ifrmSeatFrame"]');if(s){console.log("é€šè¿‡DOMå˜åŒ–ç›‘æ§å‘ç°åº§ä½iframe!"),e.disconnect(),d(s);break}}}}catch(e){a.e(e)}finally{a.f()}}));e.observe(document.body,{childList:!0,subtree:!0}),setTimeout((function(){e.disconnect(),console.log("åœæ­¢DOMç›‘æ§ (30ç§’è¶…æ—¶)")}),3e4)}()}()}function d(e){console.log("å‘ç°åº§ä½iframeï¼Œå‡†å¤‡åˆå§‹åŒ–åº§ä½åŠ©æ‰‹"),e.contentDocument&&"complete"===e.contentDocument.readyState&&e.contentDocument.querySelector(".seatarea")?(console.log("iframeå†…å®¹å·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–åº§ä½åŠ©æ‰‹"),s(e)):e.addEventListener("load",(function(){console.log("åº§ä½iframeå†…å®¹å·²åŠ è½½å®Œæˆ"),s(e)}))}function u(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return v(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?v(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,o=function(){};return{s:o,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,r=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){r=!0,s=e},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw s}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function f(){console.log("åˆå§‹åŒ–Alertè‡ªåŠ¨å¤„ç†æ¨¡å—");window.alert;window.alert=function(e){console.log("æ£€æµ‹åˆ°Alertå¼¹çª—ï¼Œå†…å®¹:",e),console.log("è‡ªåŠ¨å…³é—­Alert")};window.confirm;window.confirm=function(e){return console.log("æ£€æµ‹åˆ°Confirmå¼¹çª—ï¼Œå†…å®¹:",e),console.log("è‡ªåŠ¨ç¡®è®¤Confirm"),!0},new MutationObserver((function(e){var t,n=u(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;"childList"===a.type&&a.addedNodes.length&&document.querySelectorAll("iframe").forEach((function(e){try{e.contentWindow&&!e.alertOverridden&&(m(e),e.alertOverridden=!0)}catch(e){console.log("æ— æ³•è®¿é—®iframeå†…å®¹:",e)}}))}}catch(e){n.e(e)}finally{n.f()}})).observe(document.documentElement,{childList:!0,subtree:!0}),document.querySelectorAll("iframe").forEach((function(e){try{m(e),e.alertOverridden=!0}catch(e){console.log("æ— æ³•è®¿é—®å·²å­˜åœ¨çš„iframeå†…å®¹:",e)}})),console.log("Alertè‡ªåŠ¨å¤„ç†æ¨¡å—åˆå§‹åŒ–å®Œæˆ")}function m(e){try{e.contentWindow&&e.addEventListener("load",(function(){try{var t=e.contentWindow;t.alert,t.confirm;t.alert=function(e){console.log("æ£€æµ‹åˆ°iframeä¸­çš„Alertå¼¹çª—ï¼Œå†…å®¹:",e),console.log("è‡ªåŠ¨å…³é—­iframeä¸­çš„Alert")},t.confirm=function(e){return console.log("æ£€æµ‹åˆ°iframeä¸­çš„Confirmå¼¹çª—ï¼Œå†…å®¹:",e),console.log("è‡ªåŠ¨ç¡®è®¤iframeä¸­çš„Confirm"),!0},console.log("æˆåŠŸé‡å†™iframe alert")}catch(e){console.error("é‡å†™iframe alertå¤±è´¥:",e)}}))}catch(e){console.error("è®¿é—®iframeæ—¶å‡ºé”™:",e)}}!function(){function e(){f(),c()}console.log("Yes24è´­ç¥¨åŠ©æ‰‹å·²åŠ è½½"),"complete"===document.readyState||"interactive"===document.readyState?e():document.addEventListener("DOMContentLoaded",e)}()})();