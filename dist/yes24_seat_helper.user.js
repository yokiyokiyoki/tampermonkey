// ==UserScript==
// @name         yes24座位分析助手
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  分析yes24网站上的座位可选状态，支持限制座位选择数量，使用DOM观察器替代轮询
// @author       You
// @match        *://ticket.yes24.com/*
// @match        *://*.ticket.yes24.com/*
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_notification
// @grant        window.focus
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";
/**
 * 分析座位信息
 * @param {Document} doc - iframe的contentDocument
 * @returns {Object} 包含座位信息的对象
 */
function t(t){try{var e={allSeats:'#divSeatArray div[class^="s"]',availableSeats:"#divSeatArray div.s13",vipSeats:"#divSeatArray div.s9",rSeats:"#divSeatArray div.s6",sSeats:"#divSeatArray div.s8",selectedList:"#liSelSeat p"},n=Array.from(t.querySelectorAll(e.allSeats)||[]),a=Array.from(t.querySelectorAll(e.availableSeats)||[]),s=Array.from(t.querySelectorAll(e.vipSeats)||[]),i=Array.from(t.querySelectorAll(e.rSeats)||[]),o=Array.from(t.querySelectorAll(e.sSeats)||[]),l=Array.from(t.querySelectorAll(e.selectedList)||[]),r=n.map((function(t){var e=t.getAttribute("title")||"",n=t.id||"",a="";return a=t.classList.contains("s9")?"VIP席":t.classList.contains("s6")?"R席":t.classList.contains("s8")?"S席":"普通席",{id:n,element:t,title:e,grade:a,isAvailable:t.classList.contains("s13")}})),c=l.map((function(t){var e=t.textContent||"";return{id:e,text:e}}));return{total:n.length,available:a.length,vip:s.length,r:i.length,s:o.length,selected:l.length,seatsWithInfo:r,selectedSeatsInfo:c}}catch(t){return console.error("分析座位信息时出错:",t),{total:0,available:0,vip:0,r:0,s:0,selected:0,seatsWithInfo:[],selectedSeatsInfo:[]}}}
/**
 * 创建控制面板
 * @param {Object} seatInfo - 座位信息对象
 */
function e(t){if(document.getElementById("yes24SeatAssistant"))return console.log("面板已存在，更新数据"),void n(t);var e;console.log("创建座位助手面板"),(e=document.createElement("style")).textContent='\n        #yes24SeatAssistant {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            width: 280px;\n            background-color: rgba(33, 37, 41, 0.95);\n            color: #ffffff;\n            border-radius: 8px;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);\n            z-index: 10000;\n            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;\n            backdrop-filter: blur(5px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            overflow: hidden;\n            transition: all 0.3s ease;\n        }\n        \n        .seat-assistant-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 12px 15px;\n            background: linear-gradient(135deg, #4568dc, #3a6073);\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        \n        .seat-assistant-title {\n            font-size: 16px;\n            font-weight: bold;\n            display: flex;\n            align-items: center;\n        }\n        \n        .seat-assistant-icon {\n            margin-right: 8px;\n            font-size: 18px;\n        }\n        \n        .seat-assistant-close {\n            cursor: pointer;\n            font-size: 18px;\n            opacity: 0.8;\n            transition: opacity 0.2s;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 50%;\n        }\n        \n        .seat-assistant-close:hover {\n            opacity: 1;\n            background-color: rgba(255, 255, 255, 0.1);\n        }\n        \n        .seat-assistant-body {\n            padding: 15px;\n        }\n        \n        .seat-assistant-section {\n            margin-bottom: 15px;\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n        }\n        \n        .seat-assistant-section-title {\n            margin-bottom: 10px;\n            font-size: 14px;\n            font-weight: 500;\n            color: #adb5bd;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            padding-bottom: 5px;\n        }\n        \n        .seat-count-grid {\n            display: grid;\n            grid-template-columns: repeat(3, 1fr);\n            gap: 8px;\n        }\n        \n        .seat-count-item {\n            text-align: center;\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 4px;\n            padding: 8px 4px;\n        }\n        \n        .seat-count-label {\n            font-size: 12px;\n            color: #adb5bd;\n            margin-bottom: 4px;\n        }\n        \n        .seat-count-value {\n            font-size: 18px;\n            font-weight: bold;\n        }\n        \n        .vip-seat { color: #20c997; }\n        .r-seat { color: #339af0; }\n        .s-seat { color: #fcc419; }\n        .available-seat { color: #51cf66; }\n        .selected-seat { color: #ff6b6b; }\n        \n        .selected-seats-list {\n            max-height: 120px;\n            overflow-y: auto;\n            background: rgba(0, 0, 0, 0.15);\n            border-radius: 4px;\n            margin-top: 8px;\n        }\n        \n        .selected-seat-item {\n            padding: 6px 10px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            font-size: 13px;\n        }\n        \n        .selected-seat-item.empty {\n            color: #868e96;\n            text-align: center;\n            padding: 15px;\n        }\n    ',document.head.appendChild(e);var a=document.createElement("div");a.id="yes24SeatAssistant",a.innerHTML='\n        <div class="seat-assistant-header">\n            <div class="seat-assistant-title">\n                <span class="seat-assistant-icon">🎟️</span>\n                Yes24座位助手\n            </div>\n            <div class="seat-assistant-controls">\n                <div class="seat-assistant-close" title="关闭">×</div>\n            </div>\n        </div>\n        <div class="seat-assistant-body">\n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">座位概况</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">全部座位</div>\n                        <div class="seat-count-value" id="totalSeatsCount">'.concat(t.total,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">可选座位</div>\n                        <div class="seat-count-value available-seat" id="availableSeatsCount">').concat(t.available,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">已选座位</div>\n                        <div class="seat-count-value selected-seat" id="selectedSeatsCount">').concat(t.selected,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">座位类型</div>\n                <div class="seat-count-grid">\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">VIP席</div>\n                        <div class="seat-count-value vip-seat" id="vipSeatsCount">').concat(t.vip,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">R席</div>\n                        <div class="seat-count-value r-seat" id="rSeatsCount">').concat(t.r,'</div>\n                    </div>\n                    <div class="seat-count-item">\n                        <div class="seat-count-label">S席</div>\n                        <div class="seat-count-value s-seat" id="sSeatsCount">').concat(t.s,'</div>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="seat-assistant-section">\n                <div class="seat-assistant-section-title">已选座位</div>\n                <div class="selected-seats-list" id="selectedSeatsList">\n                    ').concat(t.selectedSeatsInfo.length>0?t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):'<div class="selected-seat-item empty">暂无已选座位</div>',"\n                </div>\n            </div>\n        </div>\n    "),document.body.appendChild(a),document.querySelector("#yes24SeatAssistant .seat-assistant-close").addEventListener("click",(function(){a.remove()})),console.log("面板创建完成")}
/**
 * 更新面板数据
 * @param {Object} seatInfo - 座位信息对象
 */function n(t){if(document.getElementById("yes24SeatAssistant")){document.getElementById("totalSeatsCount").textContent=t.total,document.getElementById("availableSeatsCount").textContent=t.available,document.getElementById("selectedSeatsCount").textContent=t.selected,document.getElementById("vipSeatsCount").textContent=t.vip,document.getElementById("rSeatsCount").textContent=t.r,document.getElementById("sSeatsCount").textContent=t.s;var e=document.getElementById("selectedSeatsList");t.selectedSeatsInfo.length>0?e.innerHTML=t.selectedSeatsInfo.map((function(t){return'<div class="selected-seat-item">'.concat(t.text,"</div>")})).join(""):e.innerHTML='<div class="selected-seat-item empty">暂无已选座位</div>'}}var a=null,s=!1;
/**
 * 初始化座位助手
 * @param {HTMLIFrameElement} iframe - 包含座位的iframe元素
 */
function i(n){if(!s)try{console.log("初始化座位助手..."),a=n,e(t(n.contentDocument)),
/**
 * 设置座位监控
 * @param {HTMLIFrameElement} iframe - 包含座位的iframe元素
 */
function(t){var e=t.contentDocument,n=e.querySelector(".seatarea");if(!n)return void console.warn("未找到座位区域，无法设置监控");new MutationObserver((function(t){t.some((function(t){return"attributes"===t.type?["class","style"].includes(t.attributeName):"childList"===t.type}))&&(console.log("检测到座位变化，更新数据"),o())})).observe(n,{childList:!0,attributes:!0,subtree:!0,attributeFilter:["class","style"]});var a=e.querySelector("#liSelSeat");a&&new MutationObserver((function(){console.log("检测到已选座位列表变化"),o()})).observe(a,{childList:!0,subtree:!0});console.log("座位监控已设置")}(n),s=!0}catch(t){console.error("初始化座位助手时出错:",t)}}function o(){a&&s&&n(t(a.contentDocument))}function l(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,s=function(){};return{s,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=Array(e);n<e;n++)a[n]=t[n];return a}function c(){console.log("初始化iframe检测模块"),function(){var t=document.querySelector('iframe[name="ifrmSeatFrame"]');if(t)return void d(t);!function(){console.log("未找到座位iframe，开始监控DOM变化");var t=new MutationObserver((function(e){var n,a=l(e);try{for(a.s();!(n=a.n()).done;){var s=n.value;if("childList"===s.type&&s.addedNodes.length){var i=document.querySelector('iframe[name="ifrmSeatFrame"]');if(i){console.log("通过DOM变化监控发现座位iframe!"),t.disconnect(),d(i);break}}}}catch(t){a.e(t)}finally{a.f()}}));t.observe(document.body,{childList:!0,subtree:!0}),setTimeout((function(){t.disconnect(),console.log("停止DOM监控 (30秒超时)")}),3e4)}()}()}function d(t){console.log("发现座位iframe，准备初始化座位助手"),t.contentDocument&&"complete"===t.contentDocument.readyState&&t.contentDocument.querySelector(".seatarea")?(console.log("iframe内容已加载，直接初始化座位助手"),i(t)):t.addEventListener("load",(function(){console.log("座位iframe内容已加载完成"),i(t)}))}!function(){function t(){c()}console.log("Yes24购票助手已加载"),"complete"===document.readyState||"interactive"===document.readyState?t():document.addEventListener("DOMContentLoaded",t)}()})();