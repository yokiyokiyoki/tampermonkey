// ==UserScript==
// @name         TicketLink自动刷新预订
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  在指定时间自动刷新页面并点击预订按钮
// @author       yoki
// @match        *://www.ticketlink.co.kr/global/zh/product/*
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function t(t,n){return function(e){if(Array.isArray(e))return e}(t)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,i,a,l=[],c=!0,s=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(o=i.call(n)).done)&&(l.push(o.value),l.length!==t);c=!0);}catch(e){s=!0,r=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(s)throw r}}return l}}(t,n)||function(t,n){if(t){if("string"==typeof t)return e(t,n);var o={}.toString.call(t).slice(8,-1);return"Object"===o&&t.constructor&&(o=t.constructor.name),"Map"===o||"Set"===o?Array.from(t):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?e(t,n):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var n="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: #fff;\n    border: 2px solid #ff6600;\n    border-radius: 5px;\n    padding: 15px;\n    z-index: 9999;\n    box-shadow: 0 0 10px rgba(0,0,0,0.2);\n    width: 250px;\n    font-family: Arial, sans-serif;\n  ",o="\n    margin-top: 0; \n    color: #ff6600; \n    text-align: center;\n    font-size: 16px;\n    font-weight: bold;\n  ",r="\n    margin-bottom: 10px;\n  ",i="\n    display: block;\n    margin-bottom: 5px;\n    font-size: 14px;\n  ",a="\n    width: 100%; \n    padding: 5px; \n    margin-top: 5px; \n    box-sizing: border-box;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n  ",l="\n    display: flex; \n    justify-content: space-between; \n    margin-top: 10px;\n  ",c="\n    background: #ff6600; \n    color: white; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-right: 5px;\n    border-radius: 3px;\n  ",s="\n    background: #ccc; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-left: 5px;\n    border-radius: 3px;\n  ",d="\n    margin-top: 10px; \n    font-size: 12px; \n    color: #666; \n    text-align: center;\n  ",u="\n    margin-top: 5px; \n    font-weight: bold; \n    text-align: center; \n    color: #ff6600;\n  ",p="\n    display: flex;\n    justify-content: space-between;\n    gap: 5px;\n  ";!function(){var e,m,f,y=(m=function(e,t){var n=document.createElement("div");return n.style.backgroundColor="rgba(52, 73, 94, 0.95)",n.style.color="#ecf0f1",n.style.padding="12px 18px",n.style.borderRadius="8px",n.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",n.style.marginBottom="12px",n.style.opacity="0",n.style.transition="opacity 0.3s ease",n.style.fontSize="14px",n.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',n.style.lineHeight="1.4",n.textContent=e,t.appendChild(n),setTimeout((function(){n.style.opacity="1"}),10),setTimeout((function(){n.style.opacity="0",setTimeout((function(){n.parentNode===t&&t.removeChild(n)}),300)}),1e4),n},(e=document.createElement("div")).style.position="fixed",e.style.top="20px",e.style.right="20px",e.style.zIndex="9999",e.style.width="300px",document.body.appendChild(e),f=e,unsafeWindow.alert,unsafeWindow.alert=function(e){m(e,f)},{showMessage:function(e){m(e,f)}});y.showMessage("Ticketlink指定时间预定助手已启动");var g=!1;function x(){var e=document.querySelector(".product_detail_info"),t=document.querySelector(".product_detail_img"),m=document.querySelectorAll("a.common_btn.btn_primary"),f=Array.from(m).find((function(e){return"购票"===e.textContent.trim()}));e&&t&&!f?function(){if(document.getElementById("ticketlink-auto-refresh-panel"))return;var e=document.createElement("div");e.id="ticketlink-auto-refresh-panel",e.style.cssText=n,e.innerHTML='\n      <h3 style="'.concat(o,'">TicketLink 自动预订</h3>\n      ').concat((t=new Date,m=t.getFullYear(),f=String(t.getMonth()+1).padStart(2,"0"),y=String(t.getDate()).padStart(2,"0"),g=String(t.getHours()).padStart(2,"0"),x=String(t.getMinutes()).padStart(2,"0"),v=String(t.getSeconds()).padStart(2,"0"),b=String(t.getMilliseconds()).padStart(3,"0"),'\n      <div style="'.concat(r,'">\n        <label style="').concat(i,'">设置刷新时间:</label>\n        <div style="').concat(p,'">\n          <input type="date" id="refresh-date" value="').concat(m,"-").concat(f,"-").concat(y,'" style="').concat(a,'">\n          <div style="display: flex; align-items: center;">\n            <input type="time" id="refresh-time" value="').concat(g,":").concat(x,'" step="1" style="').concat(a,'">\n            <div style="display: flex; flex-direction: column; margin-left: 5px;">\n              <div style="display: flex; align-items: center;">\n                <input type="number" id="refresh-seconds" value="').concat(v,'" min="0" max="59" step="1" style="').concat(a,'; width: 60px;" placeholder="秒">\n                <span style="margin: 0 5px;">.</span>\n                <input type="number" id="refresh-milliseconds" value="').concat(b,'" min="0" max="999" step="1" style="').concat(a,'; width: 70px;" placeholder="毫秒">\n              </div>\n              <div style="font-size: 10px; color: #666; text-align: center; margin-top: 2px;">秒.毫秒</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    ')),'\n      <div style="').concat(l,'">\n        <button id="start-refresh" style="').concat(c,'">\n          开始\n        </button>\n        <button id="cancel-refresh" style="').concat(s,'">\n          取消\n        </button>\n      </div>\n      <div id="status-message" style="').concat(d,'"></div>\n      <div id="countdown" style="').concat(u,'"></div>\n    '),document.body.appendChild(e),document.getElementById("start-refresh").addEventListener("click",w),document.getElementById("cancel-refresh").addEventListener("click",S);var t,m,f,y,g,x,v,b}():f&&!g&&(console.log("找到预订按钮，准备点击一次...",f),g=!0,setTimeout((function(){y.showMessage("即将点击预订按钮..."),f.click(),v&&v.disconnect(),y.showMessage("预订按钮已点击")}),3e3))}var v,b=null,h=null;function w(){var e=document.getElementById("refresh-date").value,n=document.getElementById("refresh-time").value,o=document.getElementById("refresh-seconds").value,r=document.getElementById("refresh-milliseconds").value,i=document.getElementById("status-message"),a=document.getElementById("countdown");if(!e||!n)return i.textContent="请设置有效的刷新时间",void(i.style.color="red");var l=t(n.split(":").map(Number),2),c=l[0],s=l[1],d=parseInt(o)||0,u=parseInt(r)||0,p=t(e.split("-").map(Number),3),m=p[0],f=p[1],y=p[2],g=new Date(m,f-1,y,c,s,d,u),x=new Date;if(g<=x||isNaN(g.getTime()))return i.textContent="请设置一个将来的有效时间",void(i.style.color="red");var v=g.getTime()-x.getTime();i.textContent="将在 ".concat(g.toLocaleString()," ").concat(u,"毫秒 刷新页面"),i.style.color="#008800",b&&clearTimeout(b),h&&clearInterval(h),b=setTimeout((function(){location.reload()}),v),h=setInterval((function(){var e=new Date,t=g.getTime()-e.getTime();if(t<=0)return a.textContent="刷新中...",void clearInterval(h);var n=Math.floor(t/36e5),o=Math.floor(t%36e5/6e4),r=Math.floor(t%6e4/1e3),i=t%1e3;a.textContent="倒计时: ".concat(n,"时 ").concat(o,"分 ").concat(r,"秒 ").concat(i,"毫秒")}),10)}function S(){b&&(clearTimeout(b),b=null),h&&(clearInterval(h),h=null);var e=document.getElementById("status-message"),t=document.getElementById("countdown");e.textContent="自动刷新已取消",e.style.color="#666",t.textContent=""}window.addEventListener("load",x),(v=new MutationObserver(x)).observe(document.body,{childList:!0,subtree:!0})}()})();