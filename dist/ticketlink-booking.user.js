// ==UserScript==
// @name         TicketLink自动刷新预订
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  在指定时间自动刷新页面并点击预订按钮
// @author       yoki
// @match        *://www.ticketlink.co.kr/global/zh/product/*
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";function t(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,o=Array(n);e<n;e++)o[e]=t[e];return o}function n(n,e){return function(t){if(Array.isArray(t))return t}(n)||function(t,n){var e=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=e){var o,r,a,i,c=[],l=!0,d=!1;try{if(a=(e=e.call(t)).next,0===n){if(Object(e)!==e)return;l=!1}else for(;!(l=(o=a.call(e)).done)&&(c.push(o.value),c.length!==n);l=!0);}catch(t){d=!0,r=t}finally{try{if(!l&&null!=e.return&&(i=e.return(),Object(i)!==i))return}finally{if(d)throw r}}return c}}(n,e)||function(n,e){if(n){if("string"==typeof n)return t(n,e);var o={}.toString.call(n).slice(8,-1);return"Object"===o&&n.constructor&&(o=n.constructor.name),"Map"===o||"Set"===o?Array.from(n):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?t(n,e):void 0}}(n,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var e={panel:"\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: #fff;\n    border: 2px solid #ff6600;\n    border-radius: 5px;\n    padding: 15px;\n    z-index: 9999;\n    box-shadow: 0 0 10px rgba(0,0,0,0.2);\n    width: 250px;\n    font-family: Arial, sans-serif;\n  ",heading:"\n    margin-top: 0; \n    color: #ff6600; \n    text-align: center;\n    font-size: 16px;\n    font-weight: bold;\n  ",formGroup:"\n    margin-bottom: 10px;\n  ",label:"\n    display: block;\n    margin-bottom: 5px;\n    font-size: 14px;\n  ",input:"\n    width: 100%; \n    padding: 5px; \n    margin-top: 5px; \n    box-sizing: border-box;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n  ",buttonContainer:"\n    display: flex; \n    justify-content: space-between; \n    margin-top: 10px;\n  ",primaryButton:"\n    background: #ff6600; \n    color: white; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-right: 5px;\n    border-radius: 3px;\n  ",secondaryButton:"\n    background: #ccc; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-left: 5px;\n    border-radius: 3px;\n  ",statusMessage:"\n    margin-top: 10px; \n    font-size: 12px; \n    color: #666; \n    text-align: center;\n  ",countdown:"\n    margin-top: 5px; \n    font-weight: bold; \n    text-align: center; \n    color: #ff6600;\n  ",dateTimeContainer:"\n\n  "};!function(){var t,o,r,a=(o=function(t,n){var e=document.createElement("div");return e.style.backgroundColor="rgba(52, 73, 94, 0.95)",e.style.color="#ecf0f1",e.style.padding="12px 18px",e.style.borderRadius="8px",e.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",e.style.marginBottom="12px",e.style.opacity="0",e.style.transition="opacity 0.3s ease",e.style.fontSize="14px",e.style.fontFamily='-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',e.style.lineHeight="1.4",e.textContent=t,n.appendChild(e),setTimeout((function(){e.style.opacity="1"}),10),setTimeout((function(){e.style.opacity="0",setTimeout((function(){e.parentNode===n&&n.removeChild(e)}),300)}),1e4),e},(t=document.createElement("div")).style.position="fixed",t.style.top="20px",t.style.right="20px",t.style.zIndex="9999",t.style.width="300px",document.body.appendChild(t),r=t,unsafeWindow.alert,unsafeWindow.alert=function(t){o(t,r)},{showMessage:function(t){o(t,r)}});a.showMessage("Ticketlink指定时间预定助手已启动");var i=!1;function c(){var t=document.querySelector(".product_detail_info"),n=document.querySelector(".product_detail_img"),o=document.querySelectorAll("a.common_btn.btn_primary"),r=Array.from(o).find((function(t){return"购票"===t.textContent.trim()}));t&&n&&!r?function(){if(document.getElementById("ticketlink-auto-refresh-panel"))return;var t=document.createElement("div");t.id="ticketlink-auto-refresh-panel";var n=e.panel;t.style.cssText=n,t.innerHTML='\n      <h3 style="'.concat(e.heading,'">TicketLink 自动预订</h3>\n      ').concat((o=new Date,r=o.getFullYear(),a=String(o.getMonth()+1).padStart(2,"0"),i=String(o.getDate()).padStart(2,"0"),c=String(o.getHours()).padStart(2,"0"),l=String(o.getMinutes()).padStart(2,"0"),d=String(o.getSeconds()).padStart(2,"0"),s=String(o.getMilliseconds()).padStart(3,"0"),'\n      <div style="'.concat(e.formGroup,'">\n        <label style="').concat(e.label,'">设置刷新时间:</label>\n        <div style="').concat(e.dateTimeContainer,'">\n          \x3c!-- 所有输入框使用相同的样式基础 --\x3e\n          <div style="').concat(e.inputContainer,'">\n            <input type="date" id="refresh-date" value="').concat(r,"-").concat(a,"-").concat(i,'" \n                   style="').concat(e.input,';">\n          </div>\n          <div style="').concat(e.inputContainer,'">\n            <input type="time" id="refresh-time" value="').concat(c,":").concat(l,":").concat(d,'" step="1" \n                   style="').concat(e.input,';">\n          </div>\n          <div style="').concat(e.inputContainer,'">\n            <input type="number" id="refresh-milliseconds" value="').concat(s,'" min="0" max="999" step="1" \n                   placeholder="100" style="').concat(e.input,';">\n          </div>\n        </div>\n      </div>\n    ')),'\n      <div style="').concat(e.buttonContainer,'">\n        <button id="start-refresh" style="').concat(e.primaryButton,'">\n          开始\n        </button>\n        <button id="cancel-refresh" style="').concat(e.secondaryButton,'">\n          取消\n        </button>\n      </div>\n      <div id="status-message" style="').concat(e.statusMessage,'"></div>\n      <div id="countdown" style="').concat(e.countdown,'"></div>\n    '),document.body.appendChild(t),document.getElementById("start-refresh").addEventListener("click",u),document.getElementById("cancel-refresh").addEventListener("click",p);var o,r,a,i,c,l,d,s}():r&&!i&&(console.log("找到预订按钮，准备点击一次...",r),i=!0,setTimeout((function(){a.showMessage("即将点击预订按钮..."),r.click(),l&&l.disconnect(),a.showMessage("预订按钮已点击")}),3e3))}var l,d=null,s=null;function u(){var t=document.getElementById("refresh-date").value,e=document.getElementById("refresh-time").value,o=document.getElementById("refresh-milliseconds").value,r=document.getElementById("status-message"),a=document.getElementById("countdown");if(!t||!e)return r.textContent="请设置有效的刷新时间",void(r.style.color="red");var i=e.split(":").map(Number),c=i[0]||0,l=i[1]||0,u=i[2]||0,p=parseInt(o)||0,m=n(t.split("-").map(Number),3),f=m[0],y=m[1],g=m[2],x=new Date(f,y-1,g,c,l,u,p),v=new Date;if(x<=v||isNaN(x.getTime()))return r.textContent="请设置一个将来的有效时间",void(r.style.color="red");var b=x.getTime()-v.getTime();r.textContent="将在 ".concat(f,"/").concat(y,"/").concat(g," ").concat(c,":").concat(l,":").concat(u,".").concat(p," 刷新页面"),r.style.color="#008800",d&&clearTimeout(d),s&&clearInterval(s),d=setTimeout((function(){location.reload()}),b),s=setInterval((function(){var t=new Date,n=x.getTime()-t.getTime();if(n<=0)return a.textContent="刷新中...",void clearInterval(s);var e=Math.floor(n/36e5),o=Math.floor(n%36e5/6e4),r=Math.floor(n%6e4/1e3),i=n%1e3;a.textContent="倒计时: ".concat(e,"时 ").concat(o,"分 ").concat(r,"秒 ").concat(i,"毫秒")}),10)}function p(){d&&(clearTimeout(d),d=null),s&&(clearInterval(s),s=null);var t=document.getElementById("status-message"),n=document.getElementById("countdown");t.textContent="自动刷新已取消",t.style.color="#666",n.textContent=""}window.addEventListener("load",c),(l=new MutationObserver(c)).observe(document.body,{childList:!0,subtree:!0})}()})();