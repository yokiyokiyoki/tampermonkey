// ==UserScript==
// @name         YES24自动刷新预订
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  在指定时间自动刷新页面并点击预订按钮
// @author       yoki
// @match        *://ticket.yes24.com/Pages/English/Perf/*
// @run-at       document-end
// ==/UserScript==
(()=>{"use strict";function n(n,t){(null==t||t>n.length)&&(t=n.length);for(var e=0,r=Array(t);e<t;e++)r[e]=n[e];return r}function t(t,e){return function(n){if(Array.isArray(n))return n}(t)||function(n,t){var e=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=e){var r,o,a,i,c=[],l=!0,d=!1;try{if(a=(e=e.call(n)).next,0===t){if(Object(e)!==e)return;l=!1}else for(;!(l=(r=a.call(e)).done)&&(c.push(r.value),c.length!==t);l=!0);}catch(n){d=!0,o=n}finally{try{if(!l&&null!=e.return&&(i=e.return(),Object(i)!==i))return}finally{if(d)throw o}}return c}}(t,e)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var e="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background-color: #fff;\n    border: 2px solid #ff6600;\n    border-radius: 5px;\n    padding: 15px;\n    z-index: 9999;\n    box-shadow: 0 0 10px rgba(0,0,0,0.2);\n    width: 250px;\n    font-family: Arial, sans-serif;\n  ",r="\n    margin-top: 0; \n    color: #ff6600; \n    text-align: center;\n    font-size: 16px;\n    font-weight: bold;\n  ",o="\n    margin-bottom: 10px;\n  ",a="\n    display: block;\n    margin-bottom: 5px;\n    font-size: 14px;\n  ",i="\n    width: 100%; \n    padding: 5px; \n    margin-top: 5px; \n    box-sizing: border-box;\n    border: 1px solid #ccc;\n    border-radius: 3px;\n  ",c="\n    display: flex; \n    justify-content: space-between; \n    margin-top: 10px;\n  ",l="\n    background: #ff6600; \n    color: white; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-right: 5px;\n    border-radius: 3px;\n  ",d="\n    background: #ccc; \n    border: none; \n    padding: 8px 15px; \n    cursor: pointer; \n    flex: 1; \n    margin-left: 5px;\n    border-radius: 3px;\n  ",u="\n    margin-top: 10px; \n    font-size: 12px; \n    color: #666; \n    text-align: center;\n  ",s="\n    margin-top: 5px; \n    font-weight: bold; \n    text-align: center; \n    color: #ff6600;\n  ",f="\n    display: flex;\n    justify-content: space-between;\n    gap: 5px;\n  ";!function(){var n=!1;function p(){var t=document.querySelector(".ticketinfo"),p=document.querySelector(".poster"),g=document.querySelector("a#hlkPurchase");t&&p&&!g?function(){if(document.getElementById("yes24-auto-refresh-panel"))return;var n=document.createElement("div");n.id="yes24-auto-refresh-panel",n.style.cssText=e,n.innerHTML='\n      <h3 style="'.concat(r,'">YES24 自动预订</h3>\n      ').concat((t=new Date,p=t.getFullYear(),m=String(t.getMonth()+1).padStart(2,"0"),g=String(t.getDate()).padStart(2,"0"),y=String(t.getHours()).padStart(2,"0"),v=String(t.getMinutes()).padStart(2,"0"),'\n      <div style="'.concat(o,'">\n        <label style="').concat(a,'">设置刷新时间:</label>\n        <div style="').concat(f,'">\n          <input type="date" id="refresh-date" value="').concat(p,"-").concat(m,"-").concat(g,'" style="').concat(i,'">\n          <input type="time" id="refresh-time" value="').concat(y,":").concat(v,'" style="').concat(i,'">\n        </div>\n      </div>\n    ')),'\n      <div style="').concat(c,'">\n        <button id="start-refresh" style="').concat(l,'">\n          开始\n        </button>\n        <button id="cancel-refresh" style="').concat(d,'">\n          取消\n        </button>\n      </div>\n      <div id="status-message" style="').concat(u,'"></div>\n      <div id="countdown" style="').concat(s,'"></div>\n    '),document.body.appendChild(n),document.getElementById("start-refresh").addEventListener("click",x),document.getElementById("cancel-refresh").addEventListener("click",b);var t,p,m,g,y,v}():g&&!n&&(console.log(g,"bookingBtn"),console.log("找到预订按钮，准备点击一次..."),n=!0,setTimeout((function(){return g.click()}),500),m&&m.disconnect())}var m,g=null,y=null;function x(){var n=document.getElementById("refresh-date").value,e=document.getElementById("refresh-time").value,r=document.getElementById("status-message"),o=document.getElementById("countdown");if(!n||!e)return r.textContent="请设置有效的刷新时间",void(r.style.color="red");var a=t(e.split(":").map(Number),2),i=a[0],c=a[1],l=t(n.split("-").map(Number),3),d=l[0],u=l[1],s=l[2],f=new Date(d,u-1,s,i,c,0),p=new Date;if(f<=p||isNaN(f.getTime()))return r.textContent="请设置一个将来的有效时间",void(r.style.color="red");var m=f.getTime()-p.getTime();r.textContent="将在 ".concat(f.toLocaleString()," 刷新页面"),r.style.color="#008800",g&&clearTimeout(g),y&&clearInterval(y),g=setTimeout((function(){location.reload()}),m),y=setInterval((function(){var n=new Date,t=f.getTime()-n.getTime();if(t<=0)return o.textContent="刷新中...",void clearInterval(y);var e=Math.floor(t/36e5),r=Math.floor(t%36e5/6e4),a=Math.floor(t%6e4/1e3);o.textContent="倒计时: ".concat(e,"时 ").concat(r,"分 ").concat(a,"秒")}),1e3)}function b(){g&&(clearTimeout(g),g=null),y&&(clearInterval(y),y=null);var n=document.getElementById("status-message"),t=document.getElementById("countdown");n.textContent="自动刷新已取消",n.style.color="#666",t.textContent=""}window.addEventListener("load",p),(m=new MutationObserver(p)).observe(document.body,{childList:!0,subtree:!0})}()})();